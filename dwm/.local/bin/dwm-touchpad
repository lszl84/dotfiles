#!/bin/bash
# dwm-touchpad — Apply libinput settings on start, after resume,
#                and when input devices are added (power management re-enumeration)

apply() {
    for id in $(xinput list --id-only 2>/dev/null); do
        xinput set-prop "$id" "libinput Natural Scrolling Enabled" 1 2>/dev/null || true
        xinput set-prop "$id" "libinput Tapping Enabled" 1 2>/dev/null || true
        xinput set-prop "$id" "libinput Click Method Enabled" 0 1 2>/dev/null || true
    done
}

apply

# Watch for device additions (covers power-management re-enumeration)
udevadm monitor --subsystem-match=input --udev |
while read -r line; do
    if [[ "$line" == *" add "* ]]; then
        sleep 2
        apply
    fi
done &

# Watch for system resume — wait for the hardware-level touchpad fix to finish
# before re-applying libinput settings
dbus-monitor --system "type='signal',interface='org.freedesktop.login1.Manager',member=PrepareForSleep" |
while read -r line; do
    if [[ "$line" == *"boolean false"* ]]; then
        # Wait for touchpad-fix-resume.service to finish (up to 30s)
        for _ in $(seq 1 30); do
            systemctl is-active --quiet touchpad-fix-resume.service 2>/dev/null || break
            sleep 1
        done
        sleep 1
        apply
    fi
done &

wait
