#!/bin/bash
# dwm-touchpad â€” Apply libinput settings on start and after resume

apply() {
    for id in $(xinput list --id-only 2>/dev/null); do
        xinput set-prop "$id" "libinput Natural Scrolling Enabled" 1 2>/dev/null || true
        xinput set-prop "$id" "libinput Tapping Enabled" 1 2>/dev/null || true
        xinput set-prop "$id" "libinput Click Method Enabled" 0 1 2>/dev/null || true
    done
}

apply

# After resume, wait for the kernel module reload service to finish and for
# the touchpad to reappear in xinput, then reapply settings as a safety net.
dbus-monitor --system "type='signal',interface='org.freedesktop.login1.Manager',member=PrepareForSleep" |
while read -r line; do
    if [[ "$line" == *"boolean false"* ]]; then
        # Wait for module reload service to finish (up to 30s)
        for _ in $(seq 1 60); do
            systemctl is-active --quiet touchpad-fix-resume.service 2>/dev/null || break
            sleep 0.5
        done
        # Wait for touchpad to appear in xinput (up to 10s)
        for _ in $(seq 1 50); do
            xinput list 2>/dev/null | grep -qi touchpad && break
            sleep 0.2
        done
        apply
    fi
done &

wait
